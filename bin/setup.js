// bin/setup.js
const inquirer = require('inquirer');
const fs = require('fs');
const path = require('path');
const chalk = require('chalk');

console.clear();
console.log(chalk.bold.blue("üõ°Ô∏è  HILDA Setup Wizard"));
console.log(chalk.gray("---------------------------------------------------------"));
console.log(chalk.white("Configure your AI Brain & Memory."));
console.log(chalk.gray("---------------------------------------------------------\n"));

async function setup() {
  const answers = await inquirer.prompt([
    // 1. Choose Provider
    {
      type: 'list',
      name: 'AI_PROVIDER',
      message: 'Select your AI Intelligence Provider:',
      choices: [
        { name: 'Google Gemini (Recommended for Free Tier)', value: 'gemini' },
        { name: 'OpenAI (GPT-4o, GPT-3.5)', value: 'openai' },
        { name: 'Anthropic (Claude 3.5 Sonnet)', value: 'anthropic' }
      ]
    },
    // 2. Enter Model Name
    {
      type: 'input',
      name: 'AI_MODEL_NAME',
      message: 'Enter the Model Name:',
      default: (answers) => {
        if (answers.AI_PROVIDER === 'gemini') return 'gemini-1.5-flash';
        if (answers.AI_PROVIDER === 'openai') return 'gpt-4o';
        if (answers.AI_PROVIDER === 'anthropic') return 'claude-3-5-sonnet-20240620';
      }
    },
    // 3. Enter API Key
    {
      type: 'password',
      name: 'AI_API_KEY',
      message: 'Enter your API Key (We never see this):',
      validate: input => input.length > 5 ? true : "Key looks too short!"
    },
    // 4. Supabase Config
    {
      type: 'input',
      name: 'NEXT_PUBLIC_SUPABASE_URL',
      message: 'Enter your Supabase Project URL:',
      validate: input => input.includes('supabase.co') ? true : "Must be a valid Supabase URL."
    },
    {
      type: 'password',
      name: 'NEXT_PUBLIC_SUPABASE_ANON_KEY',
      message: 'Enter your Supabase Anon Key:',
    }
  ]);

  // Create the .env content
  const envContent = Object.entries(answers)
    .map(([key, value]) => `${key}=${value}`)
    .join('\n');

  // Add GitHub defaults
  const finalEnv = envContent + `\nGITHUB_APP_ID=development_mode\n`;

  // Write to .env file
  const envPath = path.join(__dirname, '..', '.env');
  fs.writeFileSync(envPath, finalEnv);

  console.log(chalk.green("\n‚úÖ Configuration saved securely to .env"));
  
  console.log(chalk.bold.yellow("\n‚ö†Ô∏è  DB SETUP REQUIRED: Run this in Supabase SQL Editor:"));
  console.log(chalk.cyan(`
    create table pr_history (
      id bigint generated by default as identity primary key,
      repo_owner text not null,
      repo_name text not null,
      pr_number int not null,
      title text,
      author text,
      diff_content text,
      analysis text,
      risk_score text,
      commit_sha text,
      created_at timestamp with time zone default timezone('utc'::text, now()) not null
    );
  `));

  console.log(chalk.bold.blue("\nüöÄ Ready! Run 'npm run dev' to start."));
}

setup();